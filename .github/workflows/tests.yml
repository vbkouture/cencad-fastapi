name: Tests & Linting

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.12"]

#         services:
#             mongodb:
#                 image: mongo:7.0
#                 options: >-
#                     --health-cmd mongosh
#                     --health-interval 10s
#                     --health-timeout 5s
#                     --health-retries 5
#                 ports:
#                     - 27017:27017

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip setuptools wheel
                  pip install -e .[dev]

#             - name: Run tests
#               env:
#                   MONGODB_URL: mongodb://localhost:27017
#                   MONGODB_DB: testdb
#               run: pytest tests/ -v

            - name: Type check with mypy
              run: mypy app tests

            - name: Lint with ruff
              run: ruff check app tests

            - name: Format check with black
              run: black --check app tests

            # - name: Security audit with bandit
            #   run: bandit -r app -x tests || true

            # - name: Dependency audit with pip-audit
            #   run: pip-audit || true

            - name: Build Docker image
              run: docker build -t fastapi-mongo-starter .

    deploy-check:
        runs-on: ubuntu-latest
        needs: test
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - uses: actions/checkout@v4

            - name: Verify Dockerfile exists
              run: test -f Dockerfile || (echo "Dockerfile missing" && exit 1)

            - name: Verify app.yaml exists
              run: test -f app.yaml || (echo "app.yaml missing" && exit 1)

            - name: Check for secrets in code
              run: |
                  ! grep -r "mongodb+srv://" app/ --exclude-dir=__pycache__ || true
                  ! grep -r "JWT_SECRET" app/ --exclude-dir=__pycache__ || true

            - name: Deployment ready
              run: echo "âœ… Code ready for DigitalOcean App Platform deployment"
